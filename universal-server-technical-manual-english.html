<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.20.1: https://docutils.sourceforge.io/" />
<meta content="Universal Server" name="keywords" />
<title>Welcome to the Universal Server documentation</title>
<link rel="stylesheet" href="pygments-default.css" type="text/css" />
<link rel="stylesheet" href="us-main.css" type="text/css" />
<link href="us-main-icon.png" rel="icon">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div class="document" id="technical-manual-of-the-universal-server">
<h1 class="title">Technical Manual of the <tt class="docutils literal">Universal Server</tt></h1>

<span class="target" id="top"></span><p><span class="raw-html"><a name="universal-server_top"></a></span></p>
<p><span class="raw-html"><div class="banner"><p><em>Universal Server documentation</em> <a href="http://us-main.esperide.org">browse latest</a> <a href="https://olivier-boudeville.github.io/us-main/index.html">browse mirror</a> <a href="universal-server-technical-manual-english.pdf">get PDF</a> <a href="#universal-server_top">go to top</a> <a href="#us-main_toc">go to toc</a> <a href="#universal-server_bottom">go to bottom</a> <a href="api-doc/index.html">browse API</a> <a href="https://github.com/Olivier-Boudeville/us-main">go to project</a><a href="mailto:about(dash)universal-server(at)esperide(dot)com?subject=[Universal%20Server]%20Remark">email us</a></p></div></span></p>
<p><span class="raw-html"><center><img src="us-main-title.png" id="responsive-image-medium"></img></span>
</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Organisation:</th><td class="field-body"><p class="first">Copyright (C) 2019-2024 Olivier Boudeville</p>
</td>
</tr>
<tr class="field"><th class="field-name">Contact:</th><td class="field-body"><p class="first">about (dash) universal-server (at) esperide (dot) com</p>
</td>
</tr>
<tr class="field"><th class="field-name">Creation date:</th><td class="field-body"><p class="first">Saturday, May 2, 2020</p>
</td>
</tr>
<tr class="field"><th class="field-name">Lastly updated:</th><td class="field-body"><p class="first">Thursday, January 4, 2024</p>
</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body"><p class="first">0.0.16</p>
</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body"><p class="first">In progress</p>
</td>
</tr>
<tr class="field"><th class="field-name">Dedication:</th><td class="field-body"><p class="first">Users and maintainers of the <tt class="docutils literal">Universal Server</tt>.</p>
</td>
</tr>
<tr class="field"><th class="field-name">Abstract:</th><td class="field-body"><p class="first">The <a class="reference external" href="http://us-main.esperide.org/">Universal Server</a>, part of the umbrella project <a class="reference external" href="https://github.com/Olivier-Boudeville/Universal-Server">of the same name</a>, is a multi-service daemon in charge of the automation (monitoring, scheduling and performing) of various computer-based tasks, such as the proper management of the server itself or, in the future, of home automation.</p>
<p class="last">We present here a short overview of these services, to introduce them to newcomers.</p>
</td>
</tr>
</tbody>
</table>
<p><span class="raw-html"></center></span></p>
<p></p>
<p><span class="raw-html"><a name="us-main_toc"></a></span></p>
<div class="contents topic" id="topic-1">
<span id="table-of-contents"></span><p class="topic-title"><strong>Table of Contents</strong></p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="toc-entry-1">Overview</a></li>
<li><a class="reference internal" href="#layer-stack" id="toc-entry-2">Layer Stack</a></li>
<li><a class="reference internal" href="#facilities-provided-by-this-us-main-layer" id="toc-entry-3">Facilities Provided by this US-Main Layer</a><ul>
<li><a class="reference internal" href="#home-automation" id="toc-entry-4">Home Automation</a><ul>
<li><a class="reference internal" href="#presence-simulator" id="toc-entry-5">Presence Simulator</a></li>
<li><a class="reference internal" href="#alarm-system" id="toc-entry-6">Alarm System</a></li>
</ul>
</li>
<li><a class="reference internal" href="#monitoring-of-host-sensors" id="toc-entry-7">Monitoring of Host Sensors</a><ul>
<li><a class="reference internal" href="#preparing-the-setup" id="toc-entry-8">Preparing the Setup</a></li>
<li><a class="reference internal" href="#mode-of-operation-of-the-sensor-manager" id="toc-entry-9">Mode of Operation of the Sensor Manager</a></li>
</ul>
</li>
<li><a class="reference internal" href="#contact-directory-1" id="toc-entry-10">Contact Directory</a><ul>
<li><a class="reference internal" href="#contact-file-format" id="toc-entry-11">Contact File Format</a></li>
<li><a class="reference internal" href="#contact-file-location" id="toc-entry-12">Contact File Location</a></li>
</ul>
</li>
<li><a class="reference internal" href="#communication-gateway-1" id="toc-entry-13">Communication Gateway</a></li>
<li><a class="reference internal" href="#network-support-monitoring" id="toc-entry-14">Network Support Monitoring</a></li>
<li><a class="reference internal" href="#remote-monitoring-of-online-services" id="toc-entry-15">Remote Monitoring of Online Services</a></li>
<li><a class="reference internal" href="#next-services" id="toc-entry-16">Next Services</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuring-us-main" id="toc-entry-17">Configuring US-Main</a></li>
<li><a class="reference internal" href="#installing-us-main-current-stable-version-download" id="toc-entry-18">Installing US-Main: Current Stable Version &amp; Download</a><ul>
<li><a class="reference internal" href="#automated-installation-deployment" id="toc-entry-19">Automated Installation &amp; Deployment</a></li>
<li><a class="reference internal" href="#using-cutting-edge-git" id="toc-entry-20">Using Cutting-Edge GIT</a></li>
<li><a class="reference internal" href="#rebar3-based-build" id="toc-entry-21">Rebar3-based Build</a></li>
<li><a class="reference internal" href="#using-otp-related-build-runtime-conventions" id="toc-entry-22">Using OTP-Related Build/Runtime Conventions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#launching-us-main" id="toc-entry-23">Launching US-Main</a></li>
<li><a class="reference internal" href="#monitoring-us-main" id="toc-entry-24">Monitoring US-Main</a></li>
<li><a class="reference internal" href="#support" id="toc-entry-25">Support</a></li>
<li><a class="reference internal" href="#licence" id="toc-entry-26">Licence</a></li>
<li><a class="reference internal" href="#credits" id="toc-entry-27">Credits</a></li>
<li><a class="reference internal" href="#please-react" id="toc-entry-28">Please React!</a></li>
<li><a class="reference internal" href="#ending-word" id="toc-entry-29">Ending Word</a></li>
</ul>
</div>
<p></p>
<div class="section" id="overview">
<h1><a class="toc-backref" href="#toc-entry-1">Overview</a></h1>
<p>We present here a short overview of the general automated services offered by our so-called &quot;Universal Server&quot;, to introduce them to newcomers. These services are implemented by <a class="reference external" href="https://github.com/Olivier-Boudeville/us-main">US-Main</a>, which relies notably on <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common">US-Common</a>.</p>
<p>The next level of information is to read the corresponding <a class="reference external" href="https://github.com/Olivier-Boudeville/us-main/tree/master/src">source files</a>, which are intensely commented and generally straightforward.</p>
<p>The project repository is located <a class="reference external" href="https://github.com/Olivier-Boudeville/us-main">here</a>.</p>
</div>
<div class="section" id="layer-stack">
<h1><a class="toc-backref" href="#toc-entry-2">Layer Stack</a></h1>
<p>From the highest level to the lowest, as summarised <a class="reference external" href="https://github.com/Olivier-Boudeville/us-main">here</a>, a software stack involving the Universal Server usually is like:</p>
<ul class="simple">
<li>the <em>Universal Server</em> services themselves (i.e. this <a class="reference external" href="http://us.esperide.org/">US-Main</a> layer)</li>
<li>[optional] the <em>Universal Webserver</em>, i.e. <a class="reference external" href="http://us-web.esperide.org/">US-Web</a> (for web interaction)</li>
<li><a class="reference external" href="http://us-common.esperide.org/">US-Common</a> (for US base facilities)</li>
<li>[optional] <a class="reference external" href="http://mobile.esperide.org">Ceylan-Mobile</a> (for 3G connectivity, notably SMS sending, relying on the Gammu library)</li>
<li>[optional] <a class="reference external" href="http://seaplus.esperide.org">Ceylan-Seaplus</a> (prerequisite of Ceylan-Mobile, for a bridge from Erlang to the C language)</li>
<li><a class="reference external" href="https://github.com/talentdeficit/jsx">jsx</a> (to parse JSON sensor outputs)</li>
<li><a class="reference external" href="http://oceanic.esperide.org">Ceylan-Oceanic</a> (for the support of home automation, through the integration of Enocean devices and actuators; relies on <a class="reference external" href="https://github.com/Olivier-Boudeville/erlang-serial">our fork of erlang-serial</a>)</li>
<li><a class="reference external" href="http://traces.esperide.org">Ceylan-Traces</a> (for advanced runtime traces)</li>
<li><a class="reference external" href="http://wooper.esperide.org">Ceylan-WOOPER</a> (for OOP)</li>
<li><a class="reference external" href="http://myriad.esperide.org">Ceylan-Myriad</a> (as an Erlang toolbox)</li>
<li><a class="reference external" href="http://erlang.org">Erlang</a> (for the compiler and runtime)</li>
<li><a class="reference external" href="https://en.wikipedia.org/wiki/Linux">GNU/Linux</a></li>
</ul>
<p>The shorthand for <tt class="docutils literal">Universal Server</tt> is <tt class="docutils literal">us</tt>.</p>
<p></p>
</div>
<div class="section" id="facilities-provided-by-this-us-main-layer">
<h1><a class="toc-backref" href="#toc-entry-3">Facilities Provided by this US-Main Layer</a></h1>
<p>These are mainly administration services.</p>
<div class="section" id="home-automation">
<h2><a class="toc-backref" href="#toc-entry-4">Home Automation</a></h2>
<p>The US-Main server offers house automation services based on the <a class="reference external" href="https://en.wikipedia.org/wiki/EnOcean">Enocean protocol</a> and associated devices (sensors and actuators).</p>
<p>These services are implemented thanks to our <a class="reference external" href="http://oceanic.esperide.org">Ceylan-Oceanic</a> library; please refer to it for a better understanding of EURIDs, base identifiers, telegrams and so on.</p>
<p>A key point is to define the <a class="reference external" href="https://oceanic.esperide.org/#oceanic-settings">Oceanic settings</a>, so that the various devices involved can be monitored and correctly interpreted.</p>
<div class="section" id="presence-simulator">
<h3><a class="toc-backref" href="#toc-entry-5">Presence Simulator</a></h3>
<p>The goal is to give to any outside observer the illusion that a building is currently inhabited, for example by switching light(s) on and off as if actual people were busy in such a premise.</p>
<p>For that, US-Main will control an (Enocean) smart plug (itself able typically to toggle a well-chosen, low-consumption lamp visible from outside), based on intra-day logical presence slots. Such a slot is defined by two milestones, a start and a stop one (respectively to switch the smart plug on and off), which may be either a (fixed) intra-day <tt class="docutils literal">time()</tt> (hence <tt class="docutils literal">{Hour,Minute,Second}</tt>), or the <tt class="docutils literal">dawn</tt> and <tt class="docutils literal">dusk</tt> symbolic deadlines (atoms), which are then recomputed each day (based on the current date, and on the longitude and the latitude specified by the user for the location of the premise of interest).</p>
<p>The general principle, if the so-called &quot;smart-lighting&quot; feature is enabled, is to switch on a lamp during the busy hours of the day iff no natural light can be expected. All possible cases are expected to be covered (even, for extreme latitudes, days without dawn and/or dusk).</p>
<p>If smart lighting is not enabled, then during a slot of simulated presence, the actuator will be triggered unconditionally (that is whether daylight shall be expected or not).</p>
<p>By default, the following single intra-day logical presence slots, controlling a single set of actuators, are defined, for a simulated presence with smart lighting:</p>
<ul class="simple">
<li>from <tt class="docutils literal">TMorningStart = 7:30 AM</tt> to <tt class="docutils literal">TMorningStop = 8:30 AM</tt>, unless any dawn is to happen concurrently</li>
<li>from <tt class="docutils literal">TEveningStart = 6:30 PM</tt> to <tt class="docutils literal">TEveningStop = 11:45 PM</tt>, unless any dusk is to happen concurrently</li>
</ul>
<p>More generally, the user is free, through the <tt class="docutils literal">presence_simulation_settings</tt>, either to select a default policy or to specify their own presence program (constant presence or absence, or a list of presence slots), with or without smart lighting.</p>
<p>For example, in one's US-Main configuration file of interest, possibly named <tt class="docutils literal"><span class="pre">foobar-us-main-for-production.config</span></tt>, as referenced in the <tt class="docutils literal">us_main_config_filename</tt> key of <tt class="docutils literal">us.config</tt> (both files being typically in <tt class="docutils literal"><span class="pre">/etc/xdg/universal-server</span></tt>) one may go for the default program:</p>
<pre class="code erlang literal-block">
<span class="c">% The EURID of any device (typically a push button or a double rocker)</span><span class="w">
</span><span class="c">% that serves to indicate whether someone is at home:</span><span class="w">
</span><span class="c">%</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="n">presence_switching_actuator</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;004584A6&quot;</span><span class="w"> </span><span class="p">}.</span><span class="w">

</span><span class="c">% The settings in terms of presence simulation:</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="n">presence_simulation_settings</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">default</span><span class="p">,</span><span class="w"> </span><span class="n">undefined</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}.</span>
</pre>
<p>If a user-specific program is preferred, here with a single slot, with default source and target EURIDs, and with smart lighting:</p>
<pre class="code erlang literal-block">
<span class="p">{</span><span class="w"> </span><span class="n">presence_simulation_settings</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w">
 </span><span class="p">{</span><span class="w"> </span><span class="n">presence_simulation_setting</span><span class="p">,</span><span class="w"> </span><span class="n">undefined</span><span class="p">,</span><span class="w"> </span><span class="n">undefined</span><span class="p">,</span><span class="w">
   </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">23</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="n">true</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}.</span>
</pre>
<p>Note that US-Main manages gracefully DST (<em>Daylight saving time</em>).</p>
</div>
<div class="section" id="alarm-system">
<h3><a class="toc-backref" href="#toc-entry-6">Alarm System</a></h3>
<p>The principle is to monitor a set of (Enocean) sensors (typically opening detectors for doors, windows, etc.), and to report whenever a problem is detected.</p>
<p>The US-Main must be first told when the alarm system shall be active; this is typically when no one is at home, which can be notified to US-Main either by executing a script (e.g. <tt class="docutils literal"><span class="pre">leaving-home.sh</span></tt>, in charge also for example of locking all running computers) or by pushing an (Enocean) foot switch located at the front door. Then, after a configurable delay, the alarm system will be enabled.</p>
<p>All sensors are then monitored, any opening being reported.</p>
<p>Other events will be reported, whether or not the alarm system is active:</p>
<ul class="simple">
<li>when an undeclared sensor is first seen</li>
<li>if a known sensor vanishes (e.g. it has been destroyed, or it ran out of power)</li>
<li>if a jamming attempt is detected</li>
</ul>
<p>When any abnormal event occurs, US-Main logs it and may typically sends to the user notifications, by SMS and/or by e-mail.</p>
</div>
</div>
<div class="section" id="monitoring-of-host-sensors">
<h2><a class="toc-backref" href="#toc-entry-7">Monitoring of Host Sensors</a></h2>
<p>The objective here is to track the various (and numerous) sensors of interest that most modern computers include; should abnormal feedback be detected, it is to be automatically reported thanks to the <a class="reference internal" href="#communication-gateway">communication gateway</a> service.</p>
<p>The <a class="reference external" href="https://github.com/Olivier-Boudeville/us-main/blob/master/src/class_USSensorManager.erl">US Sensor Manager</a> tracks automatically many <strong>hardware sensors</strong>; at start-up it detects the main available ones, regarding:</p>
<ul class="simple">
<li><strong>temperatures</strong> at various locations: the CPU socket, the CPU package and cores themselves, any APU, the motherboard, the chipset, ACPI, some disks (e.g. NVME); in the future, adding GPU and RAM modules is considered</li>
<li>the <strong>speed of the fans</strong> known of the motherboard (as opposed to any case fan that would be directly connected to the power supply and that would remain invisible)</li>
<li><strong>chassis intrusion</strong>, should such sensors be available</li>
</ul>
<p>(other sensors like batteries, network or USB interfaces, etc. are at least currently ignored, as their measurements are mostly voltage levels)</p>
<p>From then, the sensor manager periodically monitors the various measurement points exhibited by such sensors: it does its best to filter bogus values, to detect abnormal changes and to report to the user any related issue.</p>
<div class="section" id="preparing-the-setup">
<h3><a class="toc-backref" href="#toc-entry-8">Preparing the Setup</a></h3>
<p>The monitoring done by this server relies on the <tt class="docutils literal">sensors</tt> executable (typically <tt class="docutils literal">/usr/bin/sensors</tt>, obtained generally from a package of the same
name and relying on <a class="reference external" href="https://github.com/lm-sensors/lm-sensors">lm-sensors</a>). One may install the <tt class="docutils literal"><span class="pre">i2c-tools</span></tt> package as well for DIMM information (see R2 below).</p>
<p>The <tt class="docutils literal"><span class="pre">sensors-detect</span></tt> script must have been run once by root beforehand (select then only the default, safer options, by hitting Enter repeatedly or simply use its <tt class="docutils literal"><span class="pre">--auto</span></tt> option), in order to configure sensors.</p>
<p>Sensor configuration is typically stored in <tt class="docutils literal">/etc/sensors3.conf</tt>, and must exist prior to running the US-Main server.</p>
</div>
<div class="section" id="mode-of-operation-of-the-sensor-manager">
<h3><a class="toc-backref" href="#toc-entry-9">Mode of Operation of the Sensor Manager</a></h3>
<p>Once the sensor manager is started, <strong>temperatures</strong> are periodically tracked (i.e. the currently reported one, plus minimum, maximum, and average since start) and compared to thresholds (any critical temperature as reported by the chips, and also ones set by our sensor manager itself in order to trigger alarms).</p>
<p>Abnormal temperatures (that is, going above - or even below - relevant thresholds) are then automatically timestamped and reported to the user by the US logic (i.e. notified in traces with appropriate severity, and possibly sent to the user thanks to emails and/or SMS, see the <a class="reference internal" href="#communication-gateway">communication gateway</a> service).</p>
<p>Similarly, any <strong>fan</strong> that would stop whereas not being PWM <a class="footnote-reference" href="#footnote-1" id="footnote-reference-1">[1]</a>  is reported, and the same applies should an <strong>intrusion</strong> happen.</p>
<table class="docutils footnote" frame="void" id="footnote-1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-1">[1]</a></td><td>PWM stands for <a class="reference external" href="https://en.wikipedia.org/wiki/Pulse-width_modulation">Pulse-width modulation</a>; the speed of these fans can be controlled by their power source (typically the motherboard).</td></tr>
</tbody>
</table>
<p>Many sensors report bogus values; the US Sensor Manager does its best to filter them out appropriately. This includes temperatures outside of any realistic ranges and an intrusion being reported right from US-Main startup (whereas, supposedly, it had not happened already).</p>
<div class="section" id="temperature-monitoring">
<h4>Temperature monitoring</h4>
<p>Temperatures are monitored based on all the sensors that are supported by <tt class="docutils literal"><span class="pre">lm-sensors</span></tt> (notably the motherboard and CPU ones). Many sensors report, even when they are correctly tuned, bogus values, and are more like very poor random generators (see how to <a class="reference internal" href="#mute">mute</a> them).</p>
<p>The sensor manager considers that, when it starts, most temperatures are under control. So it will consider that any too low or too high temperature reported is bogus (refer to the <tt class="docutils literal">{low,high}_bogus_temperature_threshold</tt> defines).</p>
<p>In the future, extra information sources could be used:</p>
<ul class="simple">
<li>Hard Disk Drives, thanks to hddtemp, libatasmart, udisks2 or smartmontools</li>
<li>DIMM Temperature sensors (see R2)</li>
<li>GPU, thanks to XNVCtrl for NVidia ones, or ADL SDK for ATI ones</li>
</ul>
<p>Refer to R5 for further details.</p>
<p>Note that <a class="reference external" href="https://en.wikipedia.org/wiki/Platform_Controller_Hub">Platform Controller Hub</a> (e.g. <tt class="docutils literal"><span class="pre">pch_cannonlake-virtual-*</span></tt>, <tt class="docutils literal"><span class="pre">pch_skylake-virtual-*</span></tt>, etc. ) are Intel's single-chip chipsets; they tend to run hotter than CPUs.</p>
<p>They may be reported as autonomous first-level entries, or as measurement points of the motherboard.</p>
</div>
<div class="section" id="fan-control">
<h4>Fan Control</h4>
<p>The rotation speed of the fans can be measured thanks to <tt class="docutils literal"><span class="pre">lm-sensors</span></tt> as well.</p>
<p>Note that not all fans are known of the motherboard, notably the ones that are directly controlled by the user through a button (e.g. stop/low/high) will remain invisible to all programs.</p>
<p>Currently the sensor manager is not able to discriminate between fixed-speed fans and PWM ones.</p>
<p>The <tt class="docutils literal">pulses</tt> attribute (e.g. <tt class="docutils literal">fan2_pulses</tt>) tells how many of such pulses are generated per revolution of the fan.</p>
</div>
<div class="section" id="chassis-intrusion">
<h4>Chassis Intrusion</h4>
<p>In this last case, prior to launching the US server, one may try to reset them; for example, as root:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>ls<span class="w"> </span>-l<span class="w"> </span>/sys/class/hwmon/hwmon*/intrusion*<span class="w">
</span>-rw-r--r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Jul<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">19</span>:30<span class="w"> </span>/sys/class/hwmon/hwmon3/intrusion0_alarm<span class="w">
</span>-rw-r--r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Jul<span class="w">  </span><span class="m">8</span><span class="w"> </span><span class="m">21</span>:46<span class="w"> </span>/sys/class/hwmon/hwmon3/intrusion0_beep<span class="w">
</span>-rw-r--r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Jul<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">19</span>:30<span class="w"> </span>/sys/class/hwmon/hwmon3/intrusion1_alarm<span class="w">
</span>-rw-r--r--<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">4096</span><span class="w"> </span>Jul<span class="w">  </span><span class="m">8</span><span class="w"> </span><span class="m">21</span>:46<span class="w"> </span>/sys/class/hwmon/hwmon3/intrusion1_beep<span class="w">
</span>$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="p">|</span><span class="w"> </span>/sys/class/hwmon/hwmon3/intrusion1_alarm<span class="w">
</span>$<span class="w"> </span>cat<span class="w"> </span>/sys/class/hwmon/hwmon3/intrusion1_alarm<span class="w">
</span><span class="m">1</span>
</pre>
<p>As shown, this may not succeed.</p>
</div>
<div class="section" id="muting-faulty-sensors">
<span id="mute"></span><h4>Muting Faulty Sensors</h4>
<p>Some sensors are hopelessly flawed and are bound to raise false alarms at any time.</p>
<p>Once they triggered a sufficient number of them, the safest route is to mute them, which can be done thanks to the <tt class="docutils literal">us_sensor_monitoring</tt> entry of the <a class="reference internal" href="#us-main-configuration-file">US-Main configuration file</a>.</p>
<p>Let's suppose that a sensor whose identifier is <tt class="docutils literal">{_SensorType=nct6792, _SensorInterface=isa, <span class="pre">_SensorNumber=&quot;0a20&quot;}</span></tt> shall have its measurement point <tt class="docutils literal">AUXTIN1</tt> be muted, and that one wants to disable another one, <tt class="docutils literal">{acpitz, acpi, &quot;0&quot;}</tt>, as a whole (i.e. all its measurement points).</p>
<p>It can be done with the following configuration entry:</p>
<pre class="code erlang literal-block">
<span class="p">{</span><span class="n">sensor_monitoring</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w">

   </span><span class="c">% Under that key shall be specified a list of</span><span class="w">
   </span><span class="c">% {sensor_id(), 'all_points' | [user_specified_point()]} pairs</span><span class="w">
   </span><span class="c">% in order to mute the sensors / measurement points that are known to be</span><span class="w">
   </span><span class="c">% bogus:</span><span class="w">
   </span><span class="c">%</span><span class="w">
   </span><span class="p">{</span><span class="n">muted_measurements</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w">
       </span><span class="p">{{</span><span class="n">nct6792</span><span class="p">,</span><span class="w"> </span><span class="n">isa</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;0a20&quot;</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;AUXTIN1&quot;</span><span class="p">]},</span><span class="w">
       </span><span class="p">{{</span><span class="n">acpitz</span><span class="p">,</span><span class="w"> </span><span class="n">acpi</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="p">},</span><span class="w"> </span><span class="n">all_points</span><span class="p">}</span><span class="w">
                              </span><span class="p">]}</span><span class="w">
                       </span><span class="p">]}.</span>
</pre>
</div>
<div class="section" id="other-related-technical-information">
<h4>Other Related Technical Information</h4>
<p>To access information regarding a given sensor, <tt class="docutils literal">psensor</tt> may be used: open the preferences of the sensor (click on its name in the main window), and select the menu item <em>Preferences</em>, and look at the <em>Chip</em> field. See <a class="reference external" href="https://wpitchoune.net/psensor/faq.html">this link</a> for more information.</p>
<p>The <tt class="docutils literal">sensors</tt> tool is reporting values found in the Linux virtual file system directory, in <tt class="docutils literal"><span class="pre">/sys/class/thermal/thermal_zone*/{temp,type}</span></tt> for temperatures.</p>
<p>Examples:</p>
<ul class="simple">
<li><tt class="docutils literal">Package id 0</tt> is your (first) CPU</li>
<li><tt class="docutils literal"><span class="pre">dell_smm-virtual-0</span></tt> is your CPU fan, managed by your system firmware</li>
<li><tt class="docutils literal"><span class="pre">acpitz-virtual-0</span></tt> (<em>ACPI Thermal Zone</em>) is the temperature sensor near/on your CPU socket; this sensor can be unreliable</li>
<li><tt class="docutils literal"><span class="pre">coretemp-isa-0000</span></tt> measures the temperature of the specific cores</li>
</ul>
<p>See the many comments in <a class="reference external" href="https://github.com/Olivier-Boudeville/us-main/blob/master/src/class_USSensorManager.erl">class_USSensorManager.erl</a> for more details.</p>
<p>See also the following resources:</p>
<ul class="simple">
<li><a class="reference external" href="https://askubuntu.com/questions/843231/what-is-the-meaning-of-the-output-of-the-command-sensors">R1</a>: interpreting the output of <tt class="docutils literal">sensors</tt></li>
<li><a class="reference external" href="https://wiki.archlinux.org/title/lm_sensors">R2</a>: the <tt class="docutils literal">lm_sensors</tt> documentation of Arch Linux</li>
<li><a class="reference external" href="https://www.linux.com/topic/desktop/advanced-lm-sensors-tips-and-tricks-linux-0/">R3</a> and <a class="reference external" href="https://www.linux.com/training-tutorials/jazz-lm-sensors-graphics-and-notifications-0/">R4</a>: <tt class="docutils literal"><span class="pre">lm-sensors</span></tt> tips and tricks</li>
<li><a class="reference external" href="https://wpitchoune.net/psensor/">R5</a>: information about <tt class="docutils literal">psensor</tt></li>
<li><a class="reference external" href="https://blog.hqcodeshop.fi/archives/276-Improving-Nuvoton-NCT6776-lm_sensors-output.html">R6</a>: an example of preparation/tuning of one's sensors</li>
</ul>
</div>
</div>
</div>
<div class="section" id="contact-directory-1">
<span id="contact-directory"></span><h2><a class="toc-backref" href="#toc-entry-10">Contact Directory</a></h2>
<p>The US Contact Directory server allows US-Main to track information regarding US contacts, for various purposes, including for the US <a class="reference internal" href="#communication-gateway">communication gateway</a>.</p>
<div class="section" id="contact-file-format">
<h3><a class="toc-backref" href="#toc-entry-11">Contact File Format</a></h3>
<p>Contact files are <a class="reference external" href="https://myriad.esperide.org/#etf">ETF files</a> that contain a range of information about persons and organisations of interest.</p>
<p>Each non-commented line of these files shall be of the following format:</p>
<pre class="code erlang literal-block">
<span class="p">-</span><span class="ni">type</span><span class="w"> </span><span class="n">contact_line</span><span class="p">()</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">UserId</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">user_id</span><span class="p">(),</span><span class="w">
   </span><span class="nv">FirstName</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ustring</span><span class="p">(),</span><span class="w"> </span><span class="nv">LastName</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ustring</span><span class="p">(),</span><span class="w"> </span><span class="nv">NickName</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ustring</span><span class="p">(),</span><span class="w">
   </span><span class="nv">Comment</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">ustring</span><span class="p">(),</span><span class="w"> </span><span class="nv">BirthDate</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">maybe</span><span class="p">(</span><span class="w"> </span><span class="n">ustring</span><span class="p">()</span><span class="w"> </span><span class="p">),</span><span class="w">
   </span><span class="nv">LandlineNumber</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">maybe</span><span class="p">(</span><span class="w"> </span><span class="n">ustring</span><span class="p">()</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="nv">MobileNumber</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">maybe</span><span class="p">(</span><span class="w"> </span><span class="n">ustring</span><span class="p">()</span><span class="w"> </span><span class="p">),</span><span class="w">
   </span><span class="nv">PrimaryEmailAddress</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">maybe</span><span class="p">(</span><span class="w"> </span><span class="n">ustring</span><span class="p">()</span><span class="w"> </span><span class="p">),</span><span class="w">
   </span><span class="nv">SecondaryEmailAddress</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">maybe</span><span class="p">(</span><span class="w"> </span><span class="n">ustring</span><span class="p">()</span><span class="w"> </span><span class="p">),</span><span class="w">
   </span><span class="nv">PostalAddress</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="n">maybe</span><span class="p">(</span><span class="w"> </span><span class="n">ustring</span><span class="p">()</span><span class="w"> </span><span class="p">),</span><span class="w">
   </span><span class="nv">Roles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="n">role</span><span class="p">()</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">}.</span>
</pre>
<p>A typical contact line could then be:</p>
<pre class="code erlang literal-block">
<span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;James&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Bond&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;007&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;MI6 Agent 007&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">17</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">1971</span><span class="p">},</span><span class="w">
 </span><span class="s">&quot;+44 9 81 47 25 40&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;+44 6 26 83 37 22&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;james.bond&#64;mi6.uk.org&quot;</span><span class="p">,</span><span class="w">
 </span><span class="n">undefined</span><span class="p">,</span><span class="w"> </span><span class="n">undefined</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">administrator</span><span class="p">,</span><span class="w"> </span><span class="n">secret_agent</span><span class="p">]}.</span>
</pre>
<p>See also our <a class="reference external" href="https://github.com/Olivier-Boudeville/us-main/blob/master/test/test_contact_directory.etf">test contact ETF file</a> as a full example thereof.</p>
</div>
<div class="section" id="contact-file-location">
<h3><a class="toc-backref" href="#toc-entry-12">Contact File Location</a></h3>
<p>The path to a contact file can be either specified as an absolute one, or as a relative one - in which case it will be deemed relative to the US configuration directory.</p>
<p>They may be mere symlinks pointing to contact files kept in VCS in other locations.</p>
</div>
</div>
<div class="section" id="communication-gateway-1">
<span id="communication-gateway"></span><h2><a class="toc-backref" href="#toc-entry-13">Communication Gateway</a></h2>
<p>The purpose of the US Communication Gateway is to enable (possibly two-way) exchanges with the US users.</p>
<p>Such communication is not to happen frow a web-based medium (see <a class="reference external" href="http://us-web.esperide.org">US-Web</a> for that), but through alternate modes such as SMS (relying then on <a class="reference external" href="http://mobile.esperide.org">Ceylan-Mobile</a>, itself relying on <a class="reference external" href="http://seaplus.esperide.org">Ceylan-Seaplus</a>) and/or e-mails (relying then on <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Myriad/blob/master/src/utils/email_utils.erl">the corresponding services of Ceylan-Myriad</a>).</p>
<p>For that, the correspondance between a US role (e.g. <tt class="docutils literal">administrator</tt>) and actual user information is established thanks to the <a class="reference internal" href="#contact-directory">contact directory</a> service.</p>
</div>
<div class="section" id="network-support-monitoring">
<span id="network-infrastructure-tracker"></span><h2><a class="toc-backref" href="#toc-entry-14">Network Support Monitoring</a></h2>
<p>This service allows to ensure that the local host (on which US-Main is running) enjoys a functional <strong>network support</strong>, in terms of:</p>
<ul class="simple">
<li>ICMP probes (ping)</li>
<li>Internet (IP) connectivity</li>
<li>DNS resolution</li>
</ul>
<p>This is checked by ensuring periodically that a set of target hosts, specified as direct IP addresses and/or DNS names, can indeed be interacted with through the network.</p>
<p>Of course any issue (typically outage of a given network service) is then reported by appropriate means (i.e. by SMS rather than by email then).</p>
</div>
<div class="section" id="remote-monitoring-of-online-services">
<span id="monitoring-of-online-services"></span><h2><a class="toc-backref" href="#toc-entry-15">Remote Monitoring of Online Services</a></h2>
<p>The purpose here is to monitor online services (typically websites) provided by networked peers.</p>
<p>Each service is tracked based on a set of information:</p>
<ul class="simple">
<li>protocol: <tt class="docutils literal">http</tt>, <tt class="docutils literal">https</tt>, maybe in the future <tt class="docutils literal">ftp</tt> or alike</li>
<li>base hostname, specified as a DNS name or an IP address</li>
<li>possibly a resource designator (e.g. a specific URL) for the actual checking</li>
</ul>
</div>
<div class="section" id="next-services">
<h2><a class="toc-backref" href="#toc-entry-16">Next Services</a></h2>
<p>The following services are planned (some day) for addition:</p>
<ul class="simple">
<li>UPS (<a class="reference external" href="https://en.wikipedia.org/wiki/Uninterruptible_power_supply">Uninterruptible Power Supply</a>) monitoring, to be notified whenever a related event happens (typically a power failure from the electrical grid)</li>
</ul>
</div>
</div>
<div class="section" id="configuring-us-main">
<span id="us-main-configuration-file"></span><span id="configuration"></span><h1><a class="toc-backref" href="#toc-entry-17">Configuring US-Main</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We discuss configuration before installation, as the settings of interest shall be defined prior to deployment, notably so that adequate permissions can be set on the installation, according to the user under which US-Main is intended to run.</p>
</div>
<p>The US-Main server is part of our &quot;Universal Server&quot; infrastructure, and as such relies on the <a class="reference external" href="https://us-common.esperide.org/#configuration">base US-Common configuration settings</a>.</p>
<p>So the base information of the user-specified <tt class="docutils literal">us.config</tt> file, found in the US Configuration directory (possibly located in <tt class="docutils literal"><span class="pre">/etc/xdg/universal-server/</span></tt> or <tt class="docutils literal"><span class="pre">~/.config/universal-server/</span></tt>), will apply (see <a class="reference external" href="https://github.com/Olivier-Boudeville/us-common/blob/master/priv/for-testing/us.config">this example thereof</a>).</p>
<p>Notably, in this file, a <tt class="docutils literal">us_main_config_filename</tt> entry can be specified in order to designate the US-Main configuration file that shall be used; for example:</p>
<pre class="code erlang literal-block">
<span class="p">{</span><span class="n">us_main_config_filename</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;us-main-for-tests.config&quot;</span><span class="p">}.</span>
</pre>
<p>This US-Main configuration file concentrates the settings of all the services presented below, and the ones of US-Main itself; it is additionally used by the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-main/tree/master/priv/bin">US-Main scripts</a>, notably in order to start, stop, or monitor a designated US-Main server.</p>
<p>For operational use, we recommend to create a US-Main specific user (to be set in the <tt class="docutils literal">us_username</tt> entry of one's <tt class="docutils literal">us.config</tt> file), in order to compartmentalise the accesses to resources. For example, provided a <tt class="docutils literal"><span class="pre">us-srv</span></tt> group has already been created:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>useradd<span class="w"> </span>--create-home<span class="w"> </span>--shell<span class="w"> </span>/bin/rssh<span class="w"> </span>-g<span class="w"> </span>us-srv<span class="w"> </span>main-srv
</pre>
<p>The <a class="reference internal" href="#communication-gateway">communication gateway</a> will rely on Ceylan-Mobile to send SMS. For that, a suitable 3G device (typically a USB key) will have to be used.</p>
<p>As mentioned <a class="reference external" href="https://mobile.esperide.org/#managing-dev-ttyusb-entries">in this section</a>, proper permissions must apply, so that the user (e.g. <tt class="docutils literal"><span class="pre">main-srv</span></tt>) running US-Main is able to interact with the 3G device (e.g. <tt class="docutils literal"><span class="pre">/dev/ttyUSB-my-3G-key</span></tt>).</p>
<p>So <tt class="docutils literal">gpasswd <span class="pre">-a</span> <span class="pre">main-srv</span> uucp</tt> can be executed as root (and possibly <tt class="docutils literal"><span class="pre">main-srv</span></tt> may run <tt class="docutils literal">newgrp uucp</tt>).</p>
</div>
<div class="section" id="installing-us-main-current-stable-version-download">
<span id="installation"></span><h1><a class="toc-backref" href="#toc-entry-18">Installing US-Main: Current Stable Version &amp; Download</a></h1>
<p>As mentioned, the single mandatory prerequisite of the <a class="reference external" href="https://github.com/Olivier-Boudeville/UniversalServer">Universal Server</a> is <a class="reference external" href="http://us-common.esperide.org/">US-Common</a>, which relies on <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Traces">Ceylan-Traces</a>, which implies in turn <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-WOOPER">Ceylan-WOOPER</a>, then <a class="reference external" href="https://github.com/Olivier-Boudeville/Ceylan-Myriad">Ceylan-Myriad</a> and <a class="reference external" href="http://erlang.org">Erlang</a>.</p>
<p>We prefer using GNU/Linux, sticking to the latest stable release of Erlang (refer to the corresponding <a class="reference external" href="http://myriad.esperide.org#prerequisites">Myriad prerequisite section</a>  for more precise guidelines), and building the Universal Server from sources, thanks to GNU <tt class="docutils literal">make</tt>.</p>
<p>The Universal Server <tt class="docutils literal">master</tt> branch is meant to stick to the latest stable version: we try to ensure that this main line always stays functional (sorry for the pun). Evolutions are to take place in feature branches and to be merged only when ready.</p>
<div class="section" id="automated-installation-deployment">
<h2><a class="toc-backref" href="#toc-entry-19">Automated Installation &amp; Deployment</a></h2>
<p>This is actually the simplest, safest, most used/recommended procedure: just run the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-main/blob/master/priv/bin/deploy-us-main-native-build.sh">deploy-us-main-native-build.sh</a> script (possibly with its <tt class="docutils literal"><span class="pre">--no-launch</span></tt> option if wanting just to have it ready) and hope for the best!</p>
</div>
<div class="section" id="using-cutting-edge-git">
<h2><a class="toc-backref" href="#toc-entry-20">Using Cutting-Edge GIT</a></h2>
<p>This is more or less a manual, more limited version of the previous deployment script.</p>
<p>Once Erlang is available, it should be just a matter of executing:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/Olivier-Boudeville/Ceylan-Myriad<span class="w"> </span>myriad<span class="w">
</span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>myriad<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>all<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>..<span class="w">

</span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/Olivier-Boudeville/Ceylan-WOOPER<span class="w"> </span>wooper<span class="w">
</span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>wooper<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>all<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>..<span class="w">

</span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/Olivier-Boudeville/Ceylan-Traces<span class="w"> </span>traces<span class="w">
</span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>traces<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>all<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>..<span class="w">


</span><span class="c1"># Possibly:
</span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/Olivier-Boudeville/erlang-serial<span class="w">
</span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>erlang-serial<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">DESTDIR</span><span class="o">=</span>.<span class="w"> </span>make<span class="w"> </span>install<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>..<span class="w">

</span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/Olivier-Boudeville/Ceylan-Oceanic<span class="w"> </span>oceanic<span class="w">
</span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>oceanic<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>all<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>..<span class="w">


</span><span class="c1"># Also possibly:
</span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/Olivier-Boudeville/Ceylan-Seaplus<span class="w"> </span>seaplus<span class="w">
</span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>seaplus<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>all<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>..<span class="w">

</span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/Olivier-Boudeville/Ceylan-Mobile<span class="w"> </span>mobile<span class="w">
</span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>mobile<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>all<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>..<span class="w">


</span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/Olivier-Boudeville/us-common<span class="w">
</span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>us-common<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>all<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>..<span class="w">

</span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/Olivier-Boudeville/us-main<span class="w">
</span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>us-main<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>all<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>..
</pre>
</div>
<div class="section" id="rebar3-based-build">
<h2><a class="toc-backref" href="#toc-entry-21">Rebar3-based Build</a></h2>
<p>One may prefer relying on rebar3, even if it is by far the less frequent approach taken here.</p>
<p>If wanting to be able to operate on the source code of the dependencies, appropriate symbolic links may be defined in a <tt class="docutils literal">_checkouts</tt> directory created at the root of <tt class="docutils literal"><span class="pre">us-main</span></tt>, these links pointing to relevant Git clones (typically sibling ones).</p>
<p><span class="raw-html"><a name="otp"></a></span></p>
</div>
<div class="section" id="using-otp-related-build-runtime-conventions">
<span id="otp-build"></span><h2><a class="toc-backref" href="#toc-entry-22">Using OTP-Related Build/Runtime Conventions</a></h2>
<p>As discussed in these sections of <a class="reference external" href="http://myriad.esperide.org/myriad.html#otp">Myriad</a>, <a class="reference external" href="http://wooper.esperide.org/index.html#otp">WOOPER</a>, <a class="reference external" href="http://traces.esperide.org/index.html#otp">Traces</a> and <a class="reference external" href="http://us-common.esperide.org/index.html#otp">US-Common</a>, we added the (optional) possibility of generating a Universal Server <em>OTP application</em> out of the build tree, ready to result directly in an <em>(OTP) release</em>. For that we rely on <a class="reference external" href="https://www.rebar3.org/">rebar3</a>, <a class="reference external" href="https://github.com/erlware/relx">relx</a> and <a class="reference external" href="https://hex.pm/">hex</a>.</p>
<p>Then we benefit from a standalone, complete Universal Server.</p>
<p>For more details, one may have a look at:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/Olivier-Boudeville/us-main/blob/master/conf/rebar.config.template">rebar.config.template</a>, the general rebar configuration file used when generating the Universal Server OTP application and release (implying the automatic management of Myriad and WOOPER)</li>
<li><a class="reference external" href="https://github.com/Olivier-Boudeville/us-main/blob/master/conf/rebar-for-hex.config.template">rebar-for-hex.config.template</a>, to generate a corresponding Hex package for Universal Server (whose structure and conventions is quite different from the previous OTP elements)</li>
</ul>
</div>
</div>
<div class="section" id="launching-us-main">
<span id="execution"></span><h1><a class="toc-backref" href="#toc-entry-23">Launching US-Main</a></h1>
<p>We recommend running US-Main thanks to a native build (rather than as a release), and using for that the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-main/tree/master/priv/bin/start-us-main-native-build.sh">start-us-main-native-build.sh</a> script, either directly (for testing) or through systemd (for actual use).</p>
<p>In this last case, first a symbolic link pointing to this script shall be typically created in the <tt class="docutils literal">/usr/local/bin</tt> directory of the host of interest. Then the server is to be triggered based on <tt class="docutils literal"><span class="pre">/etc/systemd/system/us-main-as-native-build.service</span></tt> (see <a class="reference external" href="https://github.com/Olivier-Boudeville/us-main/blob/master/priv/conf/us-main-as-native-build.service">us-main-as-native-build.service</a>).</p>
<p>For example:</p>
<pre class="code bash literal-block">
$<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>us-main-as-native-build<span class="w">
</span>$<span class="w"> </span>journalctl<span class="w"> </span>--pager-end<span class="w"> </span>--unit<span class="o">=</span>us-main-as-native-build.service<span class="w">
</span>$<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>us-main-as-native-build
</pre>
<p>Then one may run <tt class="docutils literal"><span class="pre">monitor-us-main.sh</span></tt> to browse its traces live at any time.</p>
<p>Like notified in the start-up message:</p>
<pre class="literal-block">
-- Starting US-Main natively-built application as user 'stallone' (EPMD port: 4506)...
       Executing application us_main_app.beam as a service (second form)
Write pipe '/tmp/launch-erl-1103261.w' found, waiting 2 seconds to ensure start-up is successful indeed.

 **************************************************************
 ** Node 'us_main' ready and running as a daemon.
 ** Use 'to_erl /tmp/launch-erl-1103261' to connect to that node.
 ** (then type CTRL-D to exit without killing the node)
 **************************************************************
 (authbind success reported)
</pre>
<p>one may use <tt class="docutils literal">to_erl</tt> to connect directly; just remember that exiting the interpreter as usual (CTRL-C twice) thus means <em>killing</em> that node; prefer CTRL-D (once).</p>
<p>For further information one may refer to the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-main/tree/master/priv/bin">US-Main shell scripts</a>, which cover various administration-related tasks (deploying, starting, monitoring, stopping an US-Main server).</p>
<p>Apparently, in some cases (not always), stopping the US-Main server (typically with <tt class="docutils literal">systemctl stop <span class="pre">us-main-as-native-build.service</span></tt>) will <em>not</em> unregister it from its EPMD, which will not be stopped either. As a consequence, any next launching of the US-Main server is bound to fail after a time-out, and the VM log file (e.g. <tt class="docutils literal"><span class="pre">/opt/universal-server/us_main-native/us_main/log/erlang.log.1</span></tt>) will confirm that a node with the same name (<tt class="docutils literal">us_main</tt>) already exists (and thus prevents the new launch).</p>
<p>In this case, the best solution is to kill that lingering EPMD (e.g. <tt class="docutils literal">epmd <span class="pre">-port</span> 4507 <span class="pre">-kill</span></tt>) or, more brutally, to run the <tt class="docutils literal"><span class="pre">kill-us-main.sh</span></tt> script (it will kill both any US-Main and its EPMD) - and then to restart US-Main.</p>
</div>
<div class="section" id="monitoring-us-main">
<h1><a class="toc-backref" href="#toc-entry-24">Monitoring US-Main</a></h1>
<p>If using the default US-Main EPMD port, checking whether an instance is running is as simple as:</p>
<pre class="code bash literal-block">
$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">ERL_EPMD_PORT</span><span class="o">=</span><span class="m">4507</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>epmd<span class="w"> </span>-names<span class="w">
</span>epmd:<span class="w"> </span>up<span class="w"> </span>and<span class="w"> </span>running<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">4507</span><span class="w"> </span>with<span class="w"> </span>data:<span class="w">
</span>name<span class="w"> </span>us_main<span class="w"> </span>at<span class="w"> </span>port<span class="w"> </span><span class="m">50002</span>
</pre>
<p>Then executing <tt class="docutils literal"><span class="pre">kill-us-main.sh</span></tt> will kill any live US-Main instance and unregister it from its EPMD (without killing any EPMD daemon).</p>
</div>
<div class="section" id="support">
<h1><a class="toc-backref" href="#toc-entry-25">Support</a></h1>
<p>Bugs, questions, remarks, patches, requests for enhancements, etc. are to be reported to the <a class="reference external" href="https://github.com/Olivier-Boudeville/us-main">project interface</a> (typically <a class="reference external" href="https://github.com/Olivier-Boudeville/us-main/issues">issues</a>) or directly at the email address mentioned at the beginning of this document.</p>
</div>
<div class="section" id="licence">
<span id="free-software"></span><h1><a class="toc-backref" href="#toc-entry-26">Licence</a></h1>
<p>The <tt class="docutils literal">Universal Server</tt> is licensed by its author (Olivier Boudeville) under the <a class="reference external" href="https://www.gnu.org/licenses/agpl-3.0.en.html">GNU Affero General Public License</a> as published by the Free Software Foundation, either version 3 of this license, or (at your option) any later version.</p>
<p>This allows the use of the Universal Server code in a wide a variety of software projects, while still maintaining copyleft on this code, ensuring improvements are shared.</p>
<p>We hope indeed that enhancements will be back-contributed (e.g. thanks to merge requests), so that everyone will be able to benefit from them.</p>
</div>
<div class="section" id="credits">
<h1><a class="toc-backref" href="#toc-entry-27">Credits</a></h1>
<p>Many thanks to David Alberto for <a class="reference external" href="https://www.astrolabe-science.fr/duree-du-jour-et-latitude/">his kind sharing in terms of computation of latitude-based daylight durations</a> (in French).</p>
</div>
<div class="section" id="please-react">
<h1><a class="toc-backref" href="#toc-entry-28">Please React!</a></h1>
<p>If you have information more detailed or more recent than those presented in this document, if you noticed errors, neglects or points insufficiently discussed, drop us a line! (for that, follow the <a class="reference internal" href="#support">Support</a> guidelines).</p>
</div>
<div class="section" id="ending-word">
<h1><a class="toc-backref" href="#toc-entry-29">Ending Word</a></h1>
<p>Have fun with the Universal Server!</p>
<p><span class="raw-html"><center><img src="us-main-title.png" id="responsive-image-small"></img></center></span>
</p>
<p><span class="raw-html"><a name="universal-server_bottom"></a></span></p>
</div>
</div>
</body>
</html>
